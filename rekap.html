<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Rekap Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- SheetJS (js-xlsx) for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* Variabel Warna */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --secondary: #10b981; /* Emerald 500 */
            --danger: #ef4444; /* Red 500 */
            --warning: #f59e0b; /* Amber 500 */
        }

        /* Gaya Umum */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6; /* Gray 100 */
        }

        /* Gaya Kalender */
        .calendar-day {
            transition: all 0.2s ease;
        }

        .calendar-day.has-order {
            background-color: rgba(16, 185, 129, 0.1);
            position: relative;
        }

        .calendar-day.has-order::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--secondary);
            border-radius: 50%;
        }

        .calendar-day:hover {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .calendar-day.selected {
            background-color: var(--primary);
            color: white;
        }

        /* Gaya Kartu Stok */
        .stock-card {
            transition: all 0.3s ease;
        }

        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .low-stock {
            border-left: 4px solid var(--danger);
        }

        .medium-stock {
            border-left: 4px solid var(--warning);
        }

        .high-stock {
            border-left: 4px solid var(--secondary);
        }

        /* Gaya Badge Status */
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
        }

        .status-new {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-processing {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Status Permintaan ATK */
        .request-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .request-approved {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .request-rejected {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Penyesuaian Tabel */
        .min-w-full th, .min-w-full td {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            vertical-align: middle;
        }

        /* Modal tanpa scroll bar */
        .modal-content {
            max-height: 90vh;
            overflow: hidden;
        }

        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Custom Scrollbar */
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Animasi Loading */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animasi untuk update realtime */
        .highlight-update {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center">
                    <img src="genetek-logo.png" alt="Logo GENETEK" class="w-10 h-10 rounded-full">
                    <h1 class="text-xl font-semibold text-gray-800 ml-3">Dashboard Admin - Rekap Lengkap</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportAllData" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>Export All Data
                    </button>
                    <button id="logoutButton" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Barang</p>
                            <h3 id="totalItems" class="text-2xl font-bold text-indigo-600 mt-1">0</h3>
                        </div>
                        <div class="bg-indigo-100 p-3 rounded-lg">
                            <i class="fas fa-boxes text-indigo-600 text-lg"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Pemesanan</p>
                            <h3 id="totalOrders" class="text-2xl font-bold text-blue-600 mt-1">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fas fa-shopping-cart text-blue-600 text-lg"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Pesanan Baru</p>
                            <h3 id="newOrders" class="text-2xl font-bold text-yellow-600 mt-1">0</h3>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <i class="fas fa-clock text-yellow-600 text-lg"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Permintaan Baru</p>
                            <h3 id="newRequests" class="text-2xl font-bold text-purple-600 mt-1">0</h3>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg">
                            <i class="fas fa-paper-plane text-purple-600 text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Kolom Kiri - Kalender dan Statistik -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Calendar Section -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-lg font-semibold text-gray-800">Kalender Pemesanan</h2>
                            </div>

                            <!-- Month Navigation -->
                            <div class="flex justify-between items-center mb-4">
                                <button id="prevMonth" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <h3 id="currentMonthYear" class="text-lg font-semibold text-gray-800">Juli 2023</h3>
                                <button id="nextMonth" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="mt-4">
                                <div class="grid grid-cols-7 gap-1 text-xs text-center text-gray-500 font-medium mb-2">
                                    <div class="py-1">Min</div>
                                    <div class="py-1">Sen</div>
                                    <div class="py-1">Sel</div>
                                    <div class="py-1">Rab</div>
                                    <div class="py-1">Kam</div>
                                    <div class="py-1">Jum</div>
                                    <div class="py-1">Sab</div>
                                </div>
                                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm">
                                    <!-- Calendar days will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Orders for Selected Day -->
                        <div class="border-t border-gray-200 px-6 py-4">
                            <h3 id="selectedDayOrdersTitle" class="font-medium text-gray-800 mb-3">Pemesanan Hari Ini</h3>
                            <div id="selectedDayOrders" class="space-y-3">
                                <p class="text-sm text-gray-500 text-center">Tidak ada pemesanan untuk tanggal ini.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Statistik Cepat</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Kategori Barang:</span>
                                <span id="totalCategories" class="text-sm font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Barang Habis:</span>
                                <span id="outOfStockItems" class="text-sm font-semibold text-red-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Pesanan Bulan Ini:</span>
                                <span id="monthlyOrders" class="text-sm font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Stok Rendah (≤20%):</span>
                                <span id="lowStockItems" class="text-sm font-semibold text-yellow-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kolom Kanan - Daftar Barang dan Pemesanan -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Tabs Navigation -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px">
                                <button id="tabItems" class="tab-button py-4 px-6 text-center border-b-2 border-indigo-500 font-medium text-sm text-indigo-600 bg-white flex-1">
                                    <i class="fas fa-boxes mr-2"></i>Daftar Barang
                                </button>
                                <button id="tabOrders" class="tab-button py-4 px-6 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 flex-1">
                                    <i class="fas fa-clipboard-list mr-2"></i>Semua Pemesanan
                                </button>
                                <button id="tabRequests" class="tab-button py-4 px-6 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 flex-1">
                                    <i class="fas fa-paper-plane mr-2"></i>Permintaan ATK
                                </button>
                            </nav>
                        </div>

                        <!-- Tab Content -->
                        <div class="p-6">
                            <!-- Tab 1: Daftar Barang -->
                            <div id="tabContentItems" class="tab-content">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Manajemen Barang</h3>
                                    <div class="flex space-x-2">
                                        <div class="relative">
                                            <input type="text" id="searchItem" placeholder="Cari barang..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                        </div>
                                        <button id="addItemButton" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-plus mr-2"></i>Tambah Barang
                                        </button>
                                        <button id="exportItemsButton" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-file-excel mr-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terakhir Dibeli</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                                    <div class="loading-spinner"></div>
                                                    Memuat data...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm text-gray-700">
                                                Menampilkan <span id="itemsDisplayStart" class="font-medium">0</span> - <span id="itemsDisplayEnd" class="font-medium">0</span> dari <span id="itemsTotal" class="font-medium">0</span> barang
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                                <button id="itemsPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div id="itemsPaginationNumbers" class="inline-flex"></div>
                                                <button id="itemsNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 2: Semua Pemesanan -->
                            <div id="tabContentOrders" class="tab-content hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Manajemen Pemesanan</h3>
                                    <div class="flex space-x-2">
                                        <div class="relative">
                                            <input type="text" id="searchOrder" placeholder="Cari pemesanan..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                        </div>
                                        <select id="statusFilter" class="border border-gray-300 rounded-md py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <option value="">Semua Status</option>
                                            <option value="Baru">Baru</option>
                                            <option value="Diproses">Diproses</option>
                                            <option value="Selesai">Selesai</option>
                                            <option value="Dibatalkan">Dibatalkan</option>
                                        </select>
                                        <button id="exportOrdersButton" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-file-excel mr-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pemesan</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departemen</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                                    <div class="loading-spinner"></div>
                                                    Memuat data...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm text-gray-700">
                                                Menampilkan <span id="ordersDisplayStart" class="font-medium">0</span> - <span id="ordersDisplayEnd" class="font-medium">0</span> dari <span id="ordersTotal" class="font-medium">0</span> pesanan
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                                <button id="ordersPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div id="ordersPaginationNumbers" class="inline-flex"></div>
                                                <button id="ordersNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 3: Permintaan ATK -->
                            <div id="tabContentRequests" class="tab-content hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Semua Permintaan ATK</h3>
                                    <div class="flex space-x-2">
                                        <select id="requestStatusFilter" class="border border-gray-300 rounded-md py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <option value="">Semua Status</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Approved">Disetujui</option>
                                            <option value="Rejected">Ditolak</option>
                                        </select>
                                        <button id="exportRequestsButton" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-file-excel mr-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div id="atkRequestsContainer" class="space-y-4">
                                    <div class="text-center py-8">
                                        <div class="loading-spinner"></div>
                                        <p class="text-gray-500 mt-2">Memuat permintaan ATK...</p>
                                    </div>
                                </div>

                                <!-- Pagination untuk Permintaan ATK -->
                                <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm text-gray-700">
                                                Menampilkan <span id="requestsDisplayStart" class="font-medium">0</span> - <span id="requestsDisplayEnd" class="font-medium">0</span> dari <span id="requestsTotal" class="font-medium">0</span> permintaan
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                                <button id="requestsPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div id="requestsPaginationNumbers" class="inline-flex"></div>
                                                <button id="requestsNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Alert dengan Pagination -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-800">Barang Stok Rendah (≤20%)</h2>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">
                                    Halaman <span id="lowStockCurrentPage" class="font-medium">1</span> dari <span id="lowStockTotalPages" class="font-medium">1</span>
                                </span>
                                <div class="flex space-x-1">
                                    <button id="lowStockPrevPage" class="relative inline-flex items-center px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 rounded-l-md">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button id="lowStockNextPage" class="relative inline-flex items-center px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 rounded-r-md">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <button id="exportLowStockButton" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-medium flex items-center">
                                    <i class="fas fa-file-excel mr-1"></i>Export
                                </button>
                            </div>
                        </div>
                        <div id="lowStockCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6">
                            <div class="text-center py-8 col-span-full">
                                <div class="loading-spinner"></div>
                                <p class="text-gray-500 mt-2">Memuat data stok rendah...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZyx64uxbS12698ENLJMCAmrJmq5HIw8w",
            authDomain: "inventoryefk.firebaseapp.com",
            projectId: "inventoryefk",
            storageBucket: "inventoryefk.firebasestorage.app",
            messagingSenderId: "734937154821",
            appId: "1:734937154821:web:63c0159cc62918a33f236c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global Variables
        let allItems = [];
        let allOrders = [];
        let allRequests = [];
        let currentCalendarDate = new Date();
        let ordersData = {};

        // Pagination Variables
        let itemsCurrentPage = 1;
        let ordersCurrentPage = 1;
        let lowStockCurrentPage = 1;
        let requestsCurrentPage = 1; // TAMBAH: Pagination untuk permintaan ATK
        const itemsPerPage = 10;
        const ordersPerPage = 10;
        const lowStockItemsPerPage = 3;
        const requestsPerPage = 5; // TAMBAH: 10 item per halaman untuk permintaan ATK

        // Real-time Listeners
        let unsubscribeItems = null;
        let unsubscribeOrders = null;
        let unsubscribeRequests = null;

        // DOM Elements
        const elements = {
            // Summary Cards
            totalItems: document.getElementById('totalItems'),
            totalOrders: document.getElementById('totalOrders'),
            newOrders: document.getElementById('newOrders'),
            newRequests: document.getElementById('newRequests'),
            outOfStockItems: document.getElementById('outOfStockItems'),
            lowStockItems: document.getElementById('lowStockItems'),
            totalCategories: document.getElementById('totalCategories'),
            monthlyOrders: document.getElementById('monthlyOrders'),

            // Calendar
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarGrid: document.getElementById('calendarGrid'),
            selectedDayOrdersTitle: document.getElementById('selectedDayOrdersTitle'),
            selectedDayOrders: document.getElementById('selectedDayOrders'),

            // Tabs
            tabItems: document.getElementById('tabItems'),
            tabOrders: document.getElementById('tabOrders'),
            tabRequests: document.getElementById('tabRequests'),
            tabContentItems: document.getElementById('tabContentItems'),
            tabContentOrders: document.getElementById('tabContentOrders'),
            tabContentRequests: document.getElementById('tabContentRequests'),

            // Items Table
            itemsTableBody: document.getElementById('itemsTableBody'),
            searchItem: document.getElementById('searchItem'),
            itemsDisplayStart: document.getElementById('itemsDisplayStart'),
            itemsDisplayEnd: document.getElementById('itemsDisplayEnd'),
            itemsTotal: document.getElementById('itemsTotal'),
            itemsPaginationNumbers: document.getElementById('itemsPaginationNumbers'),
            itemsPrevPage: document.getElementById('itemsPrevPage'),
            itemsNextPage: document.getElementById('itemsNextPage'),

            // Orders Table
            ordersTableBody: document.getElementById('ordersTableBody'),
            searchOrder: document.getElementById('searchOrder'),
            statusFilter: document.getElementById('statusFilter'),
            ordersDisplayStart: document.getElementById('ordersDisplayStart'),
            ordersDisplayEnd: document.getElementById('ordersDisplayEnd'),
            ordersTotal: document.getElementById('ordersTotal'),
            ordersPaginationNumbers: document.getElementById('ordersPaginationNumbers'),
            ordersPrevPage: document.getElementById('ordersPrevPage'),
            ordersNextPage: document.getElementById('ordersNextPage'),

            // Requests
            atkRequestsContainer: document.getElementById('atkRequestsContainer'),
            requestStatusFilter: document.getElementById('requestStatusFilter'),
            requestsDisplayStart: document.getElementById('requestsDisplayStart'),
            requestsDisplayEnd: document.getElementById('requestsDisplayEnd'),
            requestsTotal: document.getElementById('requestsTotal'),
            requestsPaginationNumbers: document.getElementById('requestsPaginationNumbers'),
            requestsPrevPage: document.getElementById('requestsPrevPage'),
            requestsNextPage: document.getElementById('requestsNextPage'),

            // Low Stock
            lowStockCards: document.getElementById('lowStockCards'),
            lowStockCurrentPage: document.getElementById('lowStockCurrentPage'),
            lowStockTotalPages: document.getElementById('lowStockTotalPages'),
            lowStockPrevPage: document.getElementById('lowStockPrevPage'),
            lowStockNextPage: document.getElementById('lowStockNextPage'),

            // Buttons
            addItemButton: document.getElementById('addItemButton'),
            exportItemsButton: document.getElementById('exportItemsButton'),
            exportOrdersButton: document.getElementById('exportOrdersButton'),
            exportRequestsButton: document.getElementById('exportRequestsButton'),
            exportLowStockButton: document.getElementById('exportLowStockButton'),
            exportAllData: document.getElementById('exportAllData'),
            logoutButton: document.getElementById('logoutButton'),

            // Navigation
            prevMonth: document.getElementById('prevMonth'),
            nextMonth: document.getElementById('nextMonth')
        };

        // Utility Functions
        function formatDate(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function formatDateTime(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStockStatus(stock, maxStock) {
            if (stock === 0) return { status: 'Habis', class: 'text-red-600 bg-red-100', color: 'red' };
            const percentage = (stock / maxStock) * 100;
            if (percentage <= 20) return { status: 'Rendah', class: 'text-red-600 bg-red-100', color: 'red' };
            if (percentage <= 50) return { status: 'Sedang', class: 'text-yellow-600 bg-yellow-100', color: 'yellow' };
            return { status: 'Cukup', class: 'text-green-600 bg-green-100', color: 'green' };
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'Baru': 'status-badge status-new',
                'Diproses': 'status-badge status-processing',
                'Selesai': 'status-badge status-completed',
                'Dibatalkan': 'status-badge status-cancelled'
            };
            return classes[status] || 'status-badge status-new';
        }

        function getRequestStatusClass(status) {
            const classes = {
                'Pending': 'request-pending',
                'Approved': 'request-approved',
                'Rejected': 'request-rejected'
            };
            return classes[status] || 'request-pending';
        }

        function getRequestStatusText(status) {
            const texts = {
                'Pending': 'Menunggu',
                'Approved': 'Disetujui',
                'Rejected': 'Ditolak'
            };
            return texts[status] || status;
        }

        // Real-time Listeners Setup
        function setupRealTimeListeners() {
            // Real-time listener untuk items
            unsubscribeItems = db.collection("office_supplies")
                .orderBy("name")
                .onSnapshot((snapshot) => {
                    allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayItems();
                    displayLowStockItems();
                    updateSummaryCards();
                    highlightUpdate('itemsTableBody');
                }, (error) => {
                    console.error("Error in items listener:", error);
                });

            // Real-time listener untuk orders
            unsubscribeOrders = db.collection("orders")
                .orderBy("createdAt", "desc")
                .onSnapshot((snapshot) => {
                    allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Process orders for calendar
                    ordersData = {};
                    allOrders.forEach(order => {
                        const orderDate = order.orderDate.toDate();
                        const dateString = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}-${String(orderDate.getDate()).padStart(2, '0')}`;
                        if (!ordersData[dateString]) {
                            ordersData[dateString] = [];
                        }
                        ordersData[dateString].push(order);
                    });
                    
                    displayOrders();
                    updateSummaryCards();
                    renderCalendar();
                    highlightUpdate('ordersTableBody');
                }, (error) => {
                    console.error("Error in orders listener:", error);
                });

            // Real-time listener untuk ATK requests
            unsubscribeRequests = db.collection("atk_requests")
                .orderBy("requestDate", "desc")
                .onSnapshot((snapshot) => {
                    allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayATKRequests();
                    updateSummaryCards();
                    highlightUpdate('atkRequestsContainer');
                }, (error) => {
                    console.error("Error in requests listener:", error);
                });
        }

        // Highlight animation for real-time updates
        function highlightUpdate(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('highlight-update');
                setTimeout(() => {
                    element.classList.remove('highlight-update');
                }, 2000);
            }
        }

        // Display Functions
        function displayItems() {
            const searchTerm = elements.searchItem.value.toLowerCase();
            const filteredItems = allItems.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );

            const startIndex = (itemsCurrentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToDisplay = filteredItems.slice(startIndex, endIndex);

            elements.itemsTableBody.innerHTML = '';

            if (itemsToDisplay.length === 0) {
                elements.itemsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada barang ditemukan
                        </td>
                    </tr>
                `;
            } else {
                itemsToDisplay.forEach((item, index) => {
                    const stockInfo = getStockStatus(item.stock, item.maxStock);
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const itemNumber = startIndex + index + 1;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${itemNumber}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-box text-indigo-600"></i>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${item.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${item.category}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-${stockInfo.color}-500 h-2 rounded-full" style="width: ${(item.stock / item.maxStock) * 100}%"></div>
                                </div>
                                <span class="text-sm font-medium text-gray-900">${item.stock}/${item.maxStock}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${stockInfo.class}">
                                ${stockInfo.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(item.lastPurchased)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-item text-indigo-600 hover:text-indigo-900 mr-3" data-id="${item.id}">
                                Edit
                            </button>
                            <button class="delete-item text-red-600 hover:text-red-900" data-id="${item.id}">
                                Hapus
                            </button>
                        </td>
                    `;
                    elements.itemsTableBody.appendChild(row);
                });

                // Add event listeners
                document.querySelectorAll('.edit-item').forEach(btn => {
                    btn.addEventListener('click', () => editItem(btn.dataset.id));
                });
                document.querySelectorAll('.delete-item').forEach(btn => {
                    btn.addEventListener('click', () => deleteItem(btn.dataset.id));
                });
            }

            updateItemsPagination(filteredItems.length);
        }

        function displayOrders() {
            const searchTerm = elements.searchOrder.value.toLowerCase();
            const statusFilter = elements.statusFilter.value;

            const filteredOrders = allOrders.filter(order => {
                const matchesSearch = 
                    order.customerName.toLowerCase().includes(searchTerm) ||
                    order.department.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || order.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            const startIndex = (ordersCurrentPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const ordersToDisplay = filteredOrders.slice(startIndex, endIndex);

            elements.ordersTableBody.innerHTML = '';

            if (ordersToDisplay.length === 0) {
                elements.ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada pesanan ditemukan
                        </td>
                    </tr>
                `;
            } else {
                ordersToDisplay.forEach((order, index) => {
                    const itemsText = order.items && order.items.length > 0 
                        ? order.items.map(item => `${item.name} (${item.quantity})`).join(', ')
                        : 'Tidak ada items';
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const orderNumber = startIndex + index + 1;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${orderNumber}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${order.customerName}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${order.department}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(order.orderDate)}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            <div class="max-w-xs truncate" title="${itemsText}">
                                ${itemsText}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select class="${getStatusBadgeClass(order.status)}" data-order-id="${order.id}">
                                <option value="Baru" ${order.status === 'Baru' ? 'selected' : ''}>Baru</option>
                                <option value="Diproses" ${order.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                <option value="Selesai" ${order.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                <option value="Dibatalkan" ${order.status === 'Dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="view-order text-indigo-600 hover:text-indigo-900 mr-3" data-order='${JSON.stringify(order)}'>
                                Detail
                            </button>
                            <button class="delete-order text-red-600 hover:text-red-900" data-order-id="${order.id}">
                                Hapus
                            </button>
                        </td>
                    `;
                    elements.ordersTableBody.appendChild(row);
                });

                // Add event listeners
                document.querySelectorAll('select[data-order-id]').forEach(select => {
                    select.addEventListener('change', function() {
                        updateOrderStatus(this.dataset.orderId, this.value);
                    });
                });
                document.querySelectorAll('.view-order').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const order = JSON.parse(this.dataset.order);
                        showOrderDetails(order);
                    });
                });
                document.querySelectorAll('.delete-order').forEach(btn => {
                    btn.addEventListener('click', function() {
                        deleteOrder(btn.dataset.orderId);
                    });
                });
            }

            updateOrdersPagination(filteredOrders.length);
        }

        function displayATKRequests() {
            const statusFilter = elements.requestStatusFilter.value;
            
            const filteredRequests = allRequests.filter(request => 
                !statusFilter || request.status === statusFilter
            );

            const startIndex = (requestsCurrentPage - 1) * requestsPerPage;
            const endIndex = startIndex + requestsPerPage;
            const requestsToDisplay = filteredRequests.slice(startIndex, endIndex);

            elements.atkRequestsContainer.innerHTML = '';

            if (requestsToDisplay.length === 0) {
                elements.atkRequestsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">Tidak ada permintaan ATK</p>
                    </div>
                `;
            } else {
                requestsToDisplay.forEach((request, index) => {
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'bg-white border border-gray-200 rounded-lg p-4';
                    const requestNumber = startIndex + index + 1;
                    requestDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-gray-500 mr-2">${requestNumber}.</span>
                                        <h4 class="text-sm font-semibold text-gray-900">${request.itemName}</h4>
                                    </div>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRequestStatusClass(request.status)}">
                                        ${getRequestStatusText(request.status)}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-600">Jumlah: ${request.quantity}</p>
                                <p class="text-xs text-gray-500 mt-1">Oleh: ${request.requesterName} (${request.department})</p>
                                <p class="text-xs text-gray-500">Catatan: ${request.notes || 'Tidak ada catatan'}</p>
                                <p class="text-xs text-gray-500 mt-2">Diajukan: ${formatDateTime(request.requestDate)}</p>
                                ${request.reviewedAt ? `
                                    <p class="text-xs text-gray-500 mt-1">Ditinjau: ${formatDateTime(request.reviewedAt)}</p>
                                ` : ''}
                            </div>
                            ${request.status === 'Pending' ? `
                                <div class="flex space-x-2 ml-4">
                                    <button class="approve-request bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm" data-id="${request.id}">
                                        Setujui
                                    </button>
                                    <button class="reject-request bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" data-id="${request.id}">
                                        Tolak
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    elements.atkRequestsContainer.appendChild(requestDiv);
                });

                // Add event listeners
                document.querySelectorAll('.approve-request').forEach(btn => {
                    btn.addEventListener('click', () => updateRequestStatus(btn.dataset.id, 'Approved'));
                });
                document.querySelectorAll('.reject-request').forEach(btn => {
                    btn.addEventListener('click', () => updateRequestStatus(btn.dataset.id, 'Rejected'));
                });
            }

            updateRequestsPagination(filteredRequests.length);
        }

        function displayLowStockItems() {
            const lowStockItems = allItems.filter(item => 
                item.stock > 0 && (item.stock / item.maxStock) * 100 <= 20
            );

            const totalPages = Math.ceil(lowStockItems.length / lowStockItemsPerPage);
            const startIndex = (lowStockCurrentPage - 1) * lowStockItemsPerPage;
            const endIndex = startIndex + lowStockItemsPerPage;
            const itemsToDisplay = lowStockItems.slice(startIndex, endIndex);

            elements.lowStockCards.innerHTML = '';
            elements.lowStockCurrentPage.textContent = lowStockCurrentPage;
            elements.lowStockTotalPages.textContent = totalPages;

            // Update tombol pagination
            elements.lowStockPrevPage.disabled = lowStockCurrentPage === 1;
            elements.lowStockNextPage.disabled = lowStockCurrentPage === totalPages || totalPages === 0;

            if (itemsToDisplay.length === 0) {
                elements.lowStockCards.innerHTML = `
                    <div class="text-center py-8 col-span-full">
                        <i class="fas fa-check-circle text-green-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">Tidak ada barang dengan stok rendah</p>
                    </div>
                `;
            } else {
                itemsToDisplay.forEach(item => {
                    const stockInfo = getStockStatus(item.stock, item.maxStock);
                    const percentage = ((item.stock / item.maxStock) * 100).toFixed(1);
                    const card = document.createElement('div');
                    card.className = `stock-card bg-white rounded-lg shadow-sm p-4 border-l-4 border-${stockInfo.color}-500`;
                    card.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-12 w-12 bg-${stockInfo.color}-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-box text-${stockInfo.color}-600"></i>
                            </div>
                            <div class="ml-4 flex-1">
                                <h3 class="text-sm font-medium text-gray-900">${item.name}</h3>
                                <p class="text-sm text-gray-500 mt-1">${item.category}</p>
                                <div class="mt-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${stockInfo.class}">
                                        Stok ${stockInfo.status} (${percentage}%)
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-${stockInfo.color}-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span>${item.stock}/${item.maxStock}</span>
                                        <span>${percentage}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    elements.lowStockCards.appendChild(card);
                });
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            elements.currentMonthYear.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            elements.calendarGrid.innerHTML = '';

            const firstDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            // Empty days before the first day of the month
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'py-2';
                elements.calendarGrid.appendChild(emptyDiv);
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'py-2 calendar-day rounded-md text-center';
                dayDiv.textContent = day;

                const dateString = `${currentCalendarDate.getFullYear()}-${String(currentCalendarDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (ordersData[dateString] && ordersData[dateString].length > 0) {
                    dayDiv.classList.add('has-order');
                }

                const today = new Date();
                if (day === today.getDate() && 
                    currentCalendarDate.getMonth() === today.getMonth() && 
                    currentCalendarDate.getFullYear() === today.getFullYear()) {
                    dayDiv.classList.add('selected');
                    updateSelectedDayOrders(today);
                }

                dayDiv.addEventListener('click', function() {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    this.classList.add('selected');
                    const clickedDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), day);
                    updateSelectedDayOrders(clickedDate);
                });

                elements.calendarGrid.appendChild(dayDiv);
            }
        }

        function updateSelectedDayOrders(date) {
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            elements.selectedDayOrdersTitle.textContent = `Pemesanan untuk ${date.getDate()} ${monthNames[date.getMonth()]}`;

            const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const ordersForDay = ordersData[dateString] || [];

            elements.selectedDayOrders.innerHTML = '';

            if (ordersForDay.length === 0) {
                elements.selectedDayOrders.innerHTML = `
                    <p class="text-sm text-gray-500 text-center">Tidak ada pemesanan untuk tanggal ini.</p>
                `;
            } else {
                ordersForDay.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'bg-gray-50 rounded-lg p-3';
                    orderDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-gray-900">${order.customerName}</p>
                                <p class="text-xs text-gray-500">${order.department}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${order.items ? order.items.length + ' items' : 'Tidak ada items'}
                                </p>
                            </div>
                            <span class="${getStatusBadgeClass(order.status)} text-xs">
                                ${order.status}
                            </span>
                        </div>
                    `;
                    elements.selectedDayOrders.appendChild(orderDiv);
                });
            }
        }

        // Pagination Functions
        function updateItemsPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            elements.itemsDisplayStart.textContent = totalItems > 0 ? (itemsCurrentPage - 1) * itemsPerPage + 1 : 0;
            elements.itemsDisplayEnd.textContent = Math.min(itemsCurrentPage * itemsPerPage, totalItems);
            elements.itemsTotal.textContent = totalItems;

            elements.itemsPaginationNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === itemsCurrentPage 
                    ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' 
                    : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    itemsCurrentPage = i;
                    displayItems();
                });
                elements.itemsPaginationNumbers.appendChild(button);
            }

            elements.itemsPrevPage.disabled = itemsCurrentPage === 1;
            elements.itemsNextPage.disabled = itemsCurrentPage === totalPages || totalPages === 0;
        }

        function updateOrdersPagination(totalOrders) {
            const totalPages = Math.ceil(totalOrders / ordersPerPage);
            
            elements.ordersDisplayStart.textContent = totalOrders > 0 ? (ordersCurrentPage - 1) * ordersPerPage + 1 : 0;
            elements.ordersDisplayEnd.textContent = Math.min(ordersCurrentPage * ordersPerPage, totalOrders);
            elements.ordersTotal.textContent = totalOrders;

            elements.ordersPaginationNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === ordersCurrentPage 
                    ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' 
                    : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    ordersCurrentPage = i;
                    displayOrders();
                });
                elements.ordersPaginationNumbers.appendChild(button);
            }

            elements.ordersPrevPage.disabled = ordersCurrentPage === 1;
            elements.ordersNextPage.disabled = ordersCurrentPage === totalPages || totalPages === 0;
        }

        // TAMBAH: Pagination untuk Permintaan ATK
        function updateRequestsPagination(totalRequests) {
            const totalPages = Math.ceil(totalRequests / requestsPerPage);
            
            elements.requestsDisplayStart.textContent = totalRequests > 0 ? (requestsCurrentPage - 1) * requestsPerPage + 1 : 0;
            elements.requestsDisplayEnd.textContent = Math.min(requestsCurrentPage * requestsPerPage, totalRequests);
            elements.requestsTotal.textContent = totalRequests;

            elements.requestsPaginationNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === requestsCurrentPage 
                    ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' 
                    : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                button.textContent = i;
                button.addEventListener('click', () => {
                    requestsCurrentPage = i;
                    displayATKRequests();
                });
                elements.requestsPaginationNumbers.appendChild(button);
            }

            elements.requestsPrevPage.disabled = requestsCurrentPage === 1;
            elements.requestsNextPage.disabled = requestsCurrentPage === totalPages || totalPages === 0;
        }

        // CRUD Operations
        async function addItem() {
            const name = prompt('Nama barang:');
            if (!name) return;

            const category = prompt('Kategori:') || 'Umum';
            const stock = parseInt(prompt('Stok awal:', '0')) || 0;
            const maxStock = parseInt(prompt('Stok maksimal:', '100')) || 100;

            try {
                await db.collection("office_supplies").add({
                    name: name,
                    category: category,
                    stock: stock,
                    maxStock: maxStock,
                    lastPurchased: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Barang berhasil ditambahkan!');
            } catch (error) {
                console.error('Error adding item:', error);
                alert('Gagal menambahkan barang: ' + error.message);
            }
        }

        async function editItem(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;

            const name = prompt('Nama barang:', item.name) || item.name;
            const category = prompt('Kategori:', item.category) || item.category;
            const stock = parseInt(prompt('Stok:', item.stock.toString())) || item.stock;
            const maxStock = parseInt(prompt('Stok maksimal:', item.maxStock.toString())) || item.maxStock;

            try {
                await db.collection("office_supplies").doc(itemId).update({
                    name: name,
                    category: category,
                    stock: stock,
                    maxStock: maxStock,
                    lastPurchased: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Barang berhasil diperbarui!');
            } catch (error) {
                console.error('Error updating item:', error);
                alert('Gagal memperbarui barang: ' + error.message);
            }
        }

        async function deleteItem(itemId) {
            if (!confirm('Apakah Anda yakin ingin menghapus barang ini?')) return;

            try {
                await db.collection("office_supplies").doc(itemId).delete();
                alert('Barang berhasil dihapus!');
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Gagal menghapus barang: ' + error.message);
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await db.collection("orders").doc(orderId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Gagal mengupdate status pesanan: ' + error.message);
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Apakah Anda yakin ingin menghapus pesanan ini?')) return;

            try {
                await db.collection("orders").doc(orderId).delete();
                alert('Pesanan berhasil dihapus!');
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Gagal menghapus pesanan: ' + error.message);
            }
        }

        async function updateRequestStatus(requestId, newStatus) {
            try {
                await db.collection("atk_requests").doc(requestId).update({
                    status: newStatus,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`Permintaan berhasil ${newStatus === 'Approved' ? 'disetujui' : 'ditolak'}!`);
            } catch (error) {
                console.error('Error updating request status:', error);
                alert('Gagal mengupdate status permintaan: ' + error.message);
            }
        }

        // Summary and Statistics
        function updateSummaryCards() {
            // Items statistics
            elements.totalItems.textContent = allItems.length;
            
            const lowStockCount = allItems.filter(item => 
                item.stock > 0 && (item.stock / item.maxStock) * 100 <= 20
            ).length;
            elements.lowStockItems.textContent = lowStockCount;
            elements.outOfStockItems.textContent = allItems.filter(item => item.stock === 0).length;

            // Orders statistics
            elements.totalOrders.textContent = allOrders.length;
            elements.newOrders.textContent = allOrders.filter(order => order.status === 'Baru').length;

            // Requests statistics
            elements.newRequests.textContent = allRequests.filter(request => request.status === 'Pending').length;

            // Additional statistics
            const categories = [...new Set(allItems.map(item => item.category))];
            elements.totalCategories.textContent = categories.length;

            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyOrders = allOrders.filter(order => {
                const orderDate = order.orderDate.toDate();
                return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
            });
            elements.monthlyOrders.textContent = monthlyOrders.length;
        }

        // Export Functions
        function exportToExcel(data, filename, sheetName) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }

        function exportItems() {
            const data = allItems.map((item, index) => ({
                'No': index + 1,
                'Nama Barang': item.name,
                'Kategori': item.category,
                'Stok': item.stock,
                'Stok Maksimal': item.maxStock,
                'Status Stok': getStockStatus(item.stock, item.maxStock).status,
                'Terakhir Dibeli': formatDate(item.lastPurchased)
            }));
            exportToExcel(data, 'data_barang', 'Barang');
        }

        function exportOrders() {
            const data = allOrders.map((order, index) => ({
                'No': index + 1,
                'Nama Pemesan': order.customerName,
                'Departemen': order.department,
                'Tanggal Pesanan': formatDate(order.orderDate),
                'Status': order.status,
                'Jumlah Item': order.items ? order.items.length : 0,
                'Items': order.items ? order.items.map(item => `${item.name} (${item.quantity})`).join('; ') : ''
            }));
            exportToExcel(data, 'data_pesanan', 'Pesanan');
        }

        function exportRequests() {
            const data = allRequests.map((request, index) => ({
                'No': index + 1,
                'Item': request.itemName,
                'Jumlah': request.quantity,
                'Pemohon': request.requesterName,
                'Departemen': request.department,
                'Catatan': request.notes || '',
                'Status': getRequestStatusText(request.status),
                'Tanggal Permintaan': formatDateTime(request.requestDate),
                'Tanggal Ditinjau': request.reviewedAt ? formatDateTime(request.reviewedAt) : ''
            }));
            exportToExcel(data, 'data_permintaan', 'Permintaan');
        }

        function exportLowStock() {
            const lowStockItems = allItems.filter(item => 
                item.stock > 0 && (item.stock / item.maxStock) * 100 <= 20
            );
            const data = lowStockItems.map((item, index) => ({
                'No': index + 1,
                'Nama Barang': item.name,
                'Kategori': item.category,
                'Stok Saat Ini': item.stock,
                'Stok Maksimal': item.maxStock,
                'Persentase Stok': `${((item.stock / item.maxStock) * 100).toFixed(1)}%`,
                'Status': getStockStatus(item.stock, item.maxStock).status
            }));
            exportToExcel(data, 'data_stok_rendah', 'Stok Rendah');
        }

        function exportAllData() {
            const wb = XLSX.utils.book_new();

            // Items sheet
            const itemsData = allItems.map((item, index) => ({
                'No': index + 1,
                'Nama Barang': item.name,
                'Kategori': item.category,
                'Stok': item.stock,
                'Stok Maksimal': item.maxStock,
                'Status Stok': getStockStatus(item.stock, item.maxStock).status,
                'Terakhir Dibeli': formatDate(item.lastPurchased)
            }));
            const itemsWs = XLSX.utils.json_to_sheet(itemsData);
            XLSX.utils.book_append_sheet(wb, itemsWs, 'Data Barang');

            // Orders sheet
            const ordersData = allOrders.map((order, index) => ({
                'No': index + 1,
                'Nama Pemesan': order.customerName,
                'Departemen': order.department,
                'Tanggal Pesanan': formatDate(order.orderDate),
                'Status': order.status,
                'Jumlah Item': order.items ? order.items.length : 0,
                'Items': order.items ? order.items.map(item => `${item.name} (${item.quantity})`).join('; ') : ''
            }));
            const ordersWs = XLSX.utils.json_to_sheet(ordersData);
            XLSX.utils.book_append_sheet(wb, ordersWs, 'Data Pesanan');

            // Requests sheet
            const requestsData = allRequests.map((request, index) => ({
                'No': index + 1,
                'Item': request.itemName,
                'Jumlah': request.quantity,
                'Pemohon': request.requesterName,
                'Departemen': request.department,
                'Catatan': request.notes || '',
                'Status': getRequestStatusText(request.status),
                'Tanggal Permintaan': formatDateTime(request.requestDate),
                'Tanggal Ditinjau': request.reviewedAt ? formatDateTime(request.reviewedAt) : ''
            }));
            const requestsWs = XLSX.utils.json_to_sheet(requestsData);
            XLSX.utils.book_append_sheet(wb, requestsWs, 'Data Permintaan');

            XLSX.writeFile(wb, 'data_lengkap_sistem_atk.xlsx');
        }

        // Modal Functions
        function showOrderDetails(order) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white modal-content">
                    <div class="mt-3">
                        <div class="flex justify-between items-center pb-3 border-b">
                            <h3 class="text-xl font-semibold text-gray-900">Detail Pesanan</h3>
                            <button class="close-modal text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="mt-4 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ID Pesanan</label>
                                    <p class="mt-1 text-sm text-gray-900">${order.id}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <p class="mt-1">
                                        <span class="${getStatusBadgeClass(order.status)}">${order.status}</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nama Pemesan</label>
                                    <p class="mt-1 text-sm text-gray-900">${order.customerName}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Departemen</label>
                                    <p class="mt-1 text-sm text-gray-900">${order.department}</p>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tanggal Pemesanan</label>
                                <p class="mt-1 text-sm text-gray-900">${formatDateTime(order.orderDate)}</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Barang yang Dipesan</label>
                                <div class="bg-gray-50 rounded-md p-4 scrollable-content">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead>
                                            <tr>
                                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                                <th class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            ${order.items && order.items.length > 0 ? 
                                                order.items.map((item, index) => `
                                                    <tr>
                                                        <td class="py-2 text-sm text-gray-900">${index + 1}</td>
                                                        <td class="py-2 text-sm text-gray-900">${item.name}</td>
                                                        <td class="py-2 text-sm text-gray-900">${item.quantity}</td>
                                                    </tr>
                                                `).join('') : 
                                                '<tr><td colspan="3" class="py-2 text-sm text-gray-500 text-center">Tidak ada barang</td></tr>'
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-4 border-t">
                                <button class="close-modal bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md text-sm font-medium">
                                    Tutup
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close modal event
            modal.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => modal.remove());
            });
        }

        // Event Listeners
        function initializeEventListeners() {
            // Tab navigation
            elements.tabItems.addEventListener('click', () => switchTab('items'));
            elements.tabOrders.addEventListener('click', () => switchTab('orders'));
            elements.tabRequests.addEventListener('click', () => switchTab('requests'));

            // Search and filter
            elements.searchItem.addEventListener('input', displayItems);
            elements.searchOrder.addEventListener('input', displayOrders);
            elements.statusFilter.addEventListener('change', displayOrders);
            elements.requestStatusFilter.addEventListener('change', displayATKRequests);

            // Pagination
            elements.itemsPrevPage.addEventListener('click', () => {
                if (itemsCurrentPage > 1) {
                    itemsCurrentPage--;
                    displayItems();
                }
            });
            elements.itemsNextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(allItems.length / itemsPerPage);
                if (itemsCurrentPage < totalPages) {
                    itemsCurrentPage++;
                    displayItems();
                }
            });
            elements.ordersPrevPage.addEventListener('click', () => {
                if (ordersCurrentPage > 1) {
                    ordersCurrentPage--;
                    displayOrders();
                }
            });
            elements.ordersNextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(allOrders.length / ordersPerPage);
                if (ordersCurrentPage < totalPages) {
                    ordersCurrentPage++;
                    displayOrders();
                }
            });

            // TAMBAH: Pagination untuk Permintaan ATK
            elements.requestsPrevPage.addEventListener('click', () => {
                if (requestsCurrentPage > 1) {
                    requestsCurrentPage--;
                    displayATKRequests();
                }
            });
            elements.requestsNextPage.addEventListener('click', () => {
                const statusFilter = elements.requestStatusFilter.value;
                const filteredRequests = allRequests.filter(request => 
                    !statusFilter || request.status === statusFilter
                );
                const totalPages = Math.ceil(filteredRequests.length / requestsPerPage);
                if (requestsCurrentPage < totalPages) {
                    requestsCurrentPage++;
                    displayATKRequests();
                }
            });

            // Low Stock Pagination
            elements.lowStockPrevPage.addEventListener('click', () => {
                if (lowStockCurrentPage > 1) {
                    lowStockCurrentPage--;
                    displayLowStockItems();
                }
            });
            elements.lowStockNextPage.addEventListener('click', () => {
                const lowStockItems = allItems.filter(item => 
                    item.stock > 0 && (item.stock / item.maxStock) * 100 <= 20
                );
                const totalPages = Math.ceil(lowStockItems.length / lowStockItemsPerPage);
                if (lowStockCurrentPage < totalPages) {
                    lowStockCurrentPage++;
                    displayLowStockItems();
                }
            });

            // Calendar navigation
            elements.prevMonth.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            elements.nextMonth.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });

            // Buttons
            elements.addItemButton.addEventListener('click', addItem);
            elements.exportItemsButton.addEventListener('click', exportItems);
            elements.exportOrdersButton.addEventListener('click', exportOrders);
            elements.exportRequestsButton.addEventListener('click', exportRequests);
            elements.exportLowStockButton.addEventListener('click', exportLowStock);
            elements.exportAllData.addEventListener('click', exportAllData);
            elements.logoutButton.addEventListener('click', () => {
                if (confirm('Apakah Anda yakin ingin logout?')) {
                    // Unsubscribe dari real-time listeners
                    if (unsubscribeItems) unsubscribeItems();
                    if (unsubscribeOrders) unsubscribeOrders();
                    if (unsubscribeRequests) unsubscribeRequests();
                    
                    auth.signOut().then(() => {
                        window.location.href = 'login.html';
                    });
                }
            });
        }

        function switchTab(tabName) {
            // Reset all tabs
            elements.tabItems.classList.remove('border-indigo-500', 'text-indigo-600');
            elements.tabOrders.classList.remove('border-indigo-500', 'text-indigo-600');
            elements.tabRequests.classList.remove('border-indigo-500', 'text-indigo-600');
            elements.tabContentItems.classList.add('hidden');
            elements.tabContentOrders.classList.add('hidden');
            elements.tabContentRequests.classList.add('hidden');

            // Activate selected tab
            switch(tabName) {
                case 'items':
                    elements.tabItems.classList.add('border-indigo-500', 'text-indigo-600');
                    elements.tabContentItems.classList.remove('hidden');
                    break;
                case 'orders':
                    elements.tabOrders.classList.add('border-indigo-500', 'text-indigo-600');
                    elements.tabContentOrders.classList.remove('hidden');
                    break;
                case 'requests':
                    elements.tabRequests.classList.add('border-indigo-500', 'text-indigo-600');
                    elements.tabContentRequests.classList.remove('hidden');
                    break;
            }
        }

        // Authentication Check
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                initializeEventListeners();
                setupRealTimeListeners();
                renderCalendar();
            }
        });

    </script>
</body>
</html>
