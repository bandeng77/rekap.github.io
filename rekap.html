<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Rekap Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <!-- SheetJS (js-xlsx) for Excel export -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* Variabel Warna */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --secondary: #10b981; /* Emerald 500 */
            --danger: #ef4444; /* Red 500 */
            --warning: #f59e0b; /* Amber 500 */
        }

        /* Gaya Umum */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6; /* Gray 100 */
        }

        /* Gaya Kalender */
        .calendar-day {
            transition: all 0.2s ease;
        }

        .calendar-day.has-order {
            background-color: rgba(16, 185, 129, 0.1);
            position: relative;
        }

        .calendar-day.has-order::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--secondary);
            border-radius: 50%;
        }

        .calendar-day:hover {
            background-color: #e5e7eb;
            cursor: pointer;
        }

        .calendar-day.selected {
            background-color: var(--primary);
            color: white;
        }

        /* Gaya Kartu Stok */
        .stock-card {
            transition: all 0.3s ease;
        }

        .stock-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .low-stock {
            border-left: 4px solid var(--danger);
        }

        .medium-stock {
            border-left: 4px solid var(--warning);
        }

        .high-stock {
            border-left: 4px solid var(--secondary);
        }

        /* Gaya Badge Status */
        .status-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
        }

        .status-new {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-processing {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Status Permintaan ATK */
        .request-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .request-approved {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .request-rejected {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        /* Penyesuaian Tabel */
        .min-w-full th, .min-w-full td {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            vertical-align: middle;
        }

        /* Modal tanpa scroll bar */
        .modal-content {
            max-height: 90vh;
            overflow: hidden;
        }

        .scrollable-content {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* Custom Scrollbar */
        .scrollable-content::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Animasi Loading */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animasi untuk update realtime */
        .highlight-update {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center">
                    <img src="genetek-logo.png" alt="Logo GENETEK" class="w-10 h-10 rounded-full">
                    <h1 class="text-xl font-semibold text-gray-800 ml-3">Dashboard Admin - Rekap Lengkap</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="exportAllData" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                        <i class="fas fa-file-excel mr-2"></i>Export All Data
                    </button>
                    <button id="logoutButton" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium flex items-center">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Barang</p>
                            <h3 id="totalItems" class="text-2xl font-bold text-indigo-600 mt-1">0</h3>
                        </div>
                        <div class="bg-indigo-100 p-3 rounded-lg">
                            <i class="fas fa-boxes text-indigo-600 text-lg"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total Pemesanan</p>
                            <h3 id="totalOrders" class="text-2xl font-bold text-blue-600 mt-1">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fas fa-shopping-cart text-blue-600 text-lg"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Pesanan Baru</p>
                            <h3 id="newOrders" class="text-2xl font-bold text-yellow-600 mt-1">0</h3>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <i class="fas fa-clock text-yellow-600 text-lg"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Permintaan Baru</p>
                            <h3 id="newRequests" class="text-2xl font-bold text-purple-600 mt-1">0</h3>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg">
                            <i class="fas fa-paper-plane text-purple-600 text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Kolom Kiri - Kalender dan Statistik -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- Calendar Section -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-lg font-semibold text-gray-800">Kalender Pemesanan</h2>
                            </div>

                            <!-- Month Navigation -->
                            <div class="flex justify-between items-center mb-4">
                                <button id="prevMonth" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <h3 id="currentMonthYear" class="text-lg font-semibold text-gray-800">Juli 2023</h3>
                                <button id="nextMonth" class="text-gray-500 hover:text-gray-700 p-1 rounded-full hover:bg-gray-100">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="mt-4">
                                <div class="grid grid-cols-7 gap-1 text-xs text-center text-gray-500 font-medium mb-2">
                                    <div class="py-1">Min</div>
                                    <div class="py-1">Sen</div>
                                    <div class="py-1">Sel</div>
                                    <div class="py-1">Rab</div>
                                    <div class="py-1">Kam</div>
                                    <div class="py-1">Jum</div>
                                    <div class="py-1">Sab</div>
                                </div>
                                <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm">
                                    <!-- Calendar days will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Orders for Selected Day -->
                        <div class="border-t border-gray-200 px-6 py-4">
                            <h3 id="selectedDayOrdersTitle" class="font-medium text-gray-800 mb-3">Pemesanan Hari Ini</h3>
                            <div id="selectedDayOrders" class="space-y-3">
                                <p class="text-sm text-gray-500 text-center">Tidak ada pemesanan untuk tanggal ini.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Statistik Cepat</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Kategori Barang:</span>
                                <span id="totalCategories" class="text-sm font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Barang Habis:</span>
                                <span id="outOfStockItems" class="text-sm font-semibold text-red-600">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Pesanan Bulan Ini:</span>
                                <span id="monthlyOrders" class="text-sm font-semibold">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Stok Rendah (≤20%):</span>
                                <span id="lowStockItems" class="text-sm font-semibold text-yellow-600">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kolom Kanan - Daftar Barang dan Pemesanan -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Tabs Navigation -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="border-b border-gray-200">
                            <nav class="flex -mb-px">
                                <button id="tabItems" class="tab-button py-4 px-6 text-center border-b-2 border-indigo-500 font-medium text-sm text-indigo-600 bg-white flex-1">
                                    <i class="fas fa-boxes mr-2"></i>Daftar Barang
                                </button>
                                <button id="tabOrders" class="tab-button py-4 px-6 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 flex-1">
                                    <i class="fas fa-clipboard-list mr-2"></i>Semua Pemesanan
                                </button>
                                <button id="tabRequests" class="tab-button py-4 px-6 text-center border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 flex-1">
                                    <i class="fas fa-paper-plane mr-2"></i>Permintaan ATK
                                </button>
                            </nav>
                        </div>

                        <!-- Tab Content -->
                        <div class="p-6">
                            <!-- Tab 1: Daftar Barang -->
                            <div id="tabContentItems" class="tab-content">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Manajemen Barang</h3>
                                    <div class="flex space-x-2">
                                        <div class="relative">
                                            <input type="text" id="searchItem" placeholder="Cari barang..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                        </div>
                                        <button id="addItemButton" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-plus mr-2"></i>Tambah Barang
                                        </button>
                                        <button id="exportItemsButton" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-file-excel mr-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stok</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terakhir Dibeli</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                                    <div class="loading-spinner"></div>
                                                    Memuat data...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm text-gray-700">
                                                Menampilkan <span id="itemsDisplayStart" class="font-medium">0</span> - <span id="itemsDisplayEnd" class="font-medium">0</span> dari <span id="itemsTotal" class="font-medium">0</span> barang
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                                <button id="itemsPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div id="itemsPaginationNumbers" class="inline-flex"></div>
                                                <button id="itemsNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 2: Semua Pemesanan -->
                            <div id="tabContentOrders" class="tab-content hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Manajemen Pemesanan</h3>
                                    <div class="flex space-x-2">
                                        <div class="relative">
                                            <input type="text" id="searchOrder" placeholder="Cari pemesanan..." class="pl-8 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                                        </div>
                                        <select id="statusFilter" class="border border-gray-300 rounded-md py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <option value="">Semua Status</option>
                                            <option value="Baru">Baru</option>
                                            <option value="Diproses">Diproses</option>
                                            <option value="Selesai">Selesai</option>
                                            <option value="Dibatalkan">Dibatalkan</option>
                                        </select>
                                        <button id="exportOrdersButton" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-file-excel mr-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pemesan</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Departemen</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                                    <div class="loading-spinner"></div>
                                                    Memuat data...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm text-gray-700">
                                                Menampilkan <span id="ordersDisplayStart" class="font-medium">0</span> - <span id="ordersDisplayEnd" class="font-medium">0</span> dari <span id="ordersTotal" class="font-medium">0</span> pesanan
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                                <button id="ordersPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div id="ordersPaginationNumbers" class="inline-flex"></div>
                                                <button id="ordersNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab 3: Permintaan ATK -->
                            <div id="tabContentRequests" class="tab-content hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Semua Permintaan ATK</h3>
                                    <div class="flex space-x-2">
                                        <select id="requestStatusFilter" class="border border-gray-300 rounded-md py-2 px-3 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                            <option value="">Semua Status</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Approved">Disetujui</option>
                                            <option value="Rejected">Ditolak</option>
                                        </select>
                                        <button id="exportRequestsButton" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium flex items-center">
                                            <i class="fas fa-file-excel mr-2"></i>Export
                                        </button>
                                    </div>
                                </div>

                                <div id="atkRequestsContainer" class="space-y-4">
                                    <div class="text-center py-8">
                                        <div class="loading-spinner"></div>
                                        <p class="text-gray-500 mt-2">Memuat permintaan ATK...</p>
                                    </div>
                                </div>

                                <!-- Pagination untuk Permintaan ATK -->
                                <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            <p class="text-sm text-gray-700">
                                                Menampilkan <span id="requestsDisplayStart" class="font-medium">0</span> - <span id="requestsDisplayEnd" class="font-medium">0</span> dari <span id="requestsTotal" class="font-medium">0</span> permintaan
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                                <button id="requestsPrevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-left"></i>
                                                </button>
                                                <div id="requestsPaginationNumbers" class="inline-flex"></div>
                                                <button id="requestsNextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                    <i class="fas fa-chevron-right"></i>
                                                </button>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Alert dengan Pagination -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-800">Barang Stok Rendah (≤20%)</h2>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">
                                    Halaman <span id="lowStockCurrentPage" class="font-medium">1</span> dari <span id="lowStockTotalPages" class="font-medium">1</span>
                                </span>
                                <div class="flex space-x-1">
                                    <button id="lowStockPrevPage" class="relative inline-flex items-center px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 rounded-l-md">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button id="lowStockNextPage" class="relative inline-flex items-center px-2 py-1 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 rounded-r-md">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <button id="exportLowStockButton" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-medium flex items-center">
                                    <i class="fas fa-file-excel mr-1"></i>Export
                                </button>
                            </div>
                        </div>
                        <div id="lowStockCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6">
                            <div class="text-center py-8 col-span-full">
                                <div class="loading-spinner"></div>
                                <p class="text-gray-500 mt-2">Memuat data stok rendah...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZyx64uxbS12698ENLJMCAmrJmq5HIw8w",
            authDomain: "inventoryefk.firebaseapp.com",
            projectId: "inventoryefk",
            storageBucket: "inventoryefk.firebasestorage.app",
            messagingSenderId: "734937154821",
            appId: "1:734937154821:web:63c0159cc62918a33f236c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global Variables
        let allItems = [];
        let allOrders = [];
        let allRequests = [];
        let currentCalendarDate = new Date();
        let ordersData = {};

        // Pagination Variables
        let itemsCurrentPage = 1;
        let ordersCurrentPage = 1;
        let lowStockCurrentPage = 1;
        let requestsCurrentPage = 1; // TAMBAH: Pagination untuk permintaan ATK
        const itemsPerPage = 10;
        const ordersPerPage = 10;
        const lowStockItemsPerPage = 3;
        const requestsPerPage = 5; // TAMBAH: 10 item per halaman untuk permintaan ATK

        // Real-time Listeners
        let unsubscribeItems = null;
        let unsubscribeOrders = null;
        let unsubscribeRequests = null;

        // DOM Elements
        const elements = {
            // Summary Cards
            totalItems: document.getElementById('totalItems'),
            totalOrders: document.getElementById('totalOrders'),
            newOrders: document.getElementById('newOrders'),
            newRequests: document.getElementById('newRequests'),
            outOfStockItems: document.getElementById('outOfStockItems'),
            lowStockItems: document.getElementById('lowStockItems'),
            totalCategories: document.getElementById('totalCategories'),
            monthlyOrders: document.getElementById('monthlyOrders'),

            // Calendar
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarGrid: document.getElementById('calendarGrid'),
            selectedDayOrdersTitle: document.getElementById('selectedDayOrdersTitle'),
            selectedDayOrders: document.getElementById('selectedDayOrders'),

            // Tabs
            tabItems: document.getElementById('tabItems'),
            tabOrders: document.getElementById('tabOrders'),
            tabRequests: document.getElementById('tabRequests'),
            tabContentItems: document.getElementById('tabContentItems'),
            tabContentOrders: document.getElementById('tabContentOrders'),
            tabContentRequests: document.getElementById('tabContentRequests'),

            // Items Table
            itemsTableBody: document.getElementById('itemsTableBody'),
            searchItem: document.getElementById('searchItem'),
            itemsDisplayStart: document.getElementById('itemsDisplayStart'),
            itemsDisplayEnd: document.getElementById('itemsDisplayEnd'),
            itemsTotal: document.getElementById('itemsTotal'),
            itemsPaginationNumbers: document.getElementById('itemsPaginationNumbers'),
            itemsPrevPage: document.getElementById('itemsPrevPage'),
            itemsNextPage: document.getElementById('itemsNextPage'),

            // Orders Table
            ordersTableBody: document.getElementById('ordersTableBody'),
            searchOrder: document.getElementById('searchOrder'),
            statusFilter: document.getElementById('statusFilter'),
            ordersDisplayStart: document.getElementById('ordersDisplayStart'),
            ordersDisplayEnd: document.getElementById('ordersDisplayEnd'),
            ordersTotal: document.getElementById('ordersTotal'),
            ordersPaginationNumbers: document.getElementById('ordersPaginationNumbers'),
            ordersPrevPage: document.getElementById('ordersPrevPage'),
            ordersNextPage: document.getElementById('ordersNextPage'),

            // Requests
            atkRequestsContainer: document.getElementById('atkRequestsContainer'),
            requestStatusFilter: document.getElementById('requestStatusFilter'),
            requestsDisplayStart: document.getElementById('requestsDisplayStart'),
            requestsDisplayEnd: document.getElementById('requestsDisplayEnd'),
            requestsTotal: document.getElementById('requestsTotal'),
            requestsPaginationNumbers: document.getElementById('requestsPaginationNumbers'),
            requestsPrevPage: document.getElementById('requestsPrevPage'),
            requestsNextPage: document.getElementById('requestsNextPage'),

            // Low Stock
            lowStockCards: document.getElementById('lowStockCards'),
            lowStockCurrentPage: document.getElementById('lowStockCurrentPage'),
            lowStockTotalPages: document.getElementById('lowStockTotalPages'),
            lowStockPrevPage: document.getElementById('lowStockPrevPage'),
            lowStockNextPage: document.getElementById('lowStockNextPage'),

            // Buttons
            addItemButton: document.getElementById('addItemButton'),
            exportItemsButton: document.getElementById('exportItemsButton'),
            exportOrdersButton: document.getElementById('exportOrdersButton'),
            exportRequestsButton: document.getElementById('exportRequestsButton'),
            exportLowStockButton: document.getElementById('exportLowStockButton'),
            exportAllData: document.getElementById('exportAllData'),
            logoutButton: document.getElementById('logoutButton'),

            // Navigation
            prevMonth: document.getElementById('prevMonth'),
            nextMonth: document.getElementById('nextMonth')
        };

        // Utility Functions
        function formatDate(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
        }

        function formatDateTime(date) {
            if (!date) return '-';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('id-ID', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStockStatus(stock, maxStock) {
            if (stock === 0) return { status: 'Habis', class: 'text-red-600 bg-red-100', color: 'red' };
            const percentage = (stock / maxStock) * 100;
            if (percentage <= 20) return { status: 'Rendah', class: 'text-red-600 bg-red-100', color: 'red' };
            if (percentage <= 50) return { status: 'Sedang', class: 'text-yellow-600 bg-yellow-100', color: 'yellow' };
            return { status: 'Aman', class: 'text-green-600 bg-green-100', color: 'green' };
        }

        function getOrderStatusClass(status) {
            switch(status) {
                case 'Baru': return 'status-new';
                case 'Diproses': return 'status-processing';
                case 'Selesai': return 'status-completed';
                case 'Dibatalkan': return 'status-cancelled';
                default: return 'status-new';
            }
        }

        function getRequestStatusClass(status) {
            switch(status) {
                case 'Pending': return 'request-pending';
                case 'Approved': return 'request-approved';
                case 'Rejected': return 'request-rejected';
                default: return 'request-pending';
            }
        }

        function calculateLowStockItems(items) {
            return items.filter(item => {
                const percentage = (item.stock / item.maxStock) * 100;
                return percentage <= 20 && item.stock > 0;
            }).length;
        }

        function calculateOutOfStockItems(items) {
            return items.filter(item => item.stock === 0).length;
        }

        function calculateTotalCategories(items) {
            const categories = new Set(items.map(item => item.category));
            return categories.size;
        }

        function calculateMonthlyOrders(orders) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            return orders.filter(order => {
                const orderDate = order.orderDate.toDate ? order.orderDate.toDate() : new Date(order.orderDate);
                return orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear;
            }).length;
        }

        function calculateNewOrders(orders) {
            return orders.filter(order => order.status === 'Baru').length;
        }

        function calculateNewRequests(requests) {
            return requests.filter(request => request.status === 'Pending').length;
        }

        // Firebase Functions
        function initializeFirebaseListeners() {
            // Items listener
            unsubscribeItems = db.collection('items')
                .onSnapshot(snapshot => {
                    allItems = [];
                    snapshot.forEach(doc => {
                        allItems.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateItemsTable();
                    updateLowStockCards();
                    updateSummaryCards();
                }, error => {
                    console.error('Error listening to items:', error);
                });

            // Orders listener
            unsubscribeOrders = db.collection('orders')
                .onSnapshot(snapshot => {
                    allOrders = [];
                    snapshot.forEach(doc => {
                        allOrders.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateOrdersTable();
                    updateCalendar();
                    updateSummaryCards();
                }, error => {
                    console.error('Error listening to orders:', error);
                });

            // Requests listener
            unsubscribeRequests = db.collection('atkRequests')
                .onSnapshot(snapshot => {
                    allRequests = [];
                    snapshot.forEach(doc => {
                        allRequests.push({ id: doc.id, ...doc.data() });
                    });
                    
                    updateRequestsDisplay();
                    updateSummaryCards();
                }, error => {
                    console.error('Error listening to requests:', error);
                });
        }

        // Update Summary Cards
        function updateSummaryCards() {
            elements.totalItems.textContent = allItems.length;
            elements.totalOrders.textContent = allOrders.length;
            elements.newOrders.textContent = calculateNewOrders(allOrders);
            elements.newRequests.textContent = calculateNewRequests(allRequests);
            elements.outOfStockItems.textContent = calculateOutOfStockItems(allItems);
            elements.lowStockItems.textContent = calculateLowStockItems(allItems);
            elements.totalCategories.textContent = calculateTotalCategories(allItems);
            elements.monthlyOrders.textContent = calculateMonthlyOrders(allOrders);
        }

        // Calendar Functions
        function updateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update month and year display
            elements.currentMonthYear.textContent = currentCalendarDate.toLocaleDateString('id-ID', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get day of week for first day (0 = Sunday, 1 = Monday, etc.)
            let firstDayIndex = firstDay.getDay();
            // Adjust for Indonesian calendar (Monday as first day)
            firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
            
            // Clear calendar grid
            elements.calendarGrid.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day py-2 text-center text-gray-400';
                elements.calendarGrid.appendChild(emptyCell);
            }
            
            // Add cells for each day of the month
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day py-2 text-center';
                
                // Check if this day has orders
                const hasOrders = allOrders.some(order => {
                    const orderDate = order.orderDate.toDate ? order.orderDate.toDate() : new Date(order.orderDate);
                    const orderDateString = orderDate.toISOString().split('T')[0];
                    return orderDateString === dateString;
                });
                
                // Add classes based on date
                if (date.toDateString() === today.toDateString()) {
                    dayElement.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                }
                
                if (hasOrders) {
                    dayElement.classList.add('has-order');
                }
                
                dayElement.textContent = day;
                dayElement.dataset.date = dateString;
                
                // Add click event
                dayElement.addEventListener('click', () => {
                    // Remove selected class from all days
                    document.querySelectorAll('.calendar-day').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked day
                    dayElement.classList.add('selected');
                    
                    // Show orders for selected day
                    showOrdersForDate(date);
                });
                
                elements.calendarGrid.appendChild(dayElement);
            }
            
            // Auto-select today if it's in the current month view
            if (month === today.getMonth() && year === today.getFullYear()) {
                const todayElement = document.querySelector(`.calendar-day[data-date="${today.toISOString().split('T')[0]}"]`);
                if (todayElement) {
                    todayElement.click();
                }
            }
        }

        function showOrdersForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            
            // Filter orders for the selected date
            const ordersForDate = allOrders.filter(order => {
                const orderDate = order.orderDate.toDate ? order.orderDate.toDate() : new Date(order.orderDate);
                const orderDateString = orderDate.toISOString().split('T')[0];
                return orderDateString === dateString;
            });
            
            // Update title
            elements.selectedDayOrdersTitle.textContent = `Pemesanan ${formatDate(date)}`;
            
            // Update orders list
            if (ordersForDate.length === 0) {
                elements.selectedDayOrders.innerHTML = '<p class="text-sm text-gray-500 text-center">Tidak ada pemesanan untuk tanggal ini.</p>';
                return;
            }
            
            let ordersHTML = '';
            ordersForDate.forEach(order => {
                ordersHTML += `
                    <div class="border border-gray-200 rounded-lg p-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-gray-800">${order.customerName}</p>
                                <p class="text-xs text-gray-500">${order.department}</p>
                            </div>
                            <span class="status-badge ${getOrderStatusClass(order.status)}">${order.status}</span>
                        </div>
                        <div class="mt-2 text-sm text-gray-600">
                            <p>${order.items.length} item</p>
                        </div>
                    </div>
                `;
            });
            
            elements.selectedDayOrders.innerHTML = ordersHTML;
        }

        // Items Management Functions
        function updateItemsTable() {
            const searchTerm = elements.searchItem.value.toLowerCase();
            const filteredItems = allItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );

            // Calculate pagination
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            const startIndex = (itemsCurrentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
            const paginatedItems = filteredItems.slice(startIndex, endIndex);

            // Update table
            if (paginatedItems.length === 0) {
                elements.itemsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data barang.
                        </td>
                    </tr>
                `;
            } else {
                let itemsHTML = '';
                paginatedItems.forEach((item, index) => {
                    const stockStatus = getStockStatus(item.stock, item.maxStock);
                    itemsHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${startIndex + index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${item.name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${item.stock} / ${item.maxStock}</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-${stockStatus.color}-500 h-2 rounded-full" style="width: ${(item.stock / item.maxStock) * 100}%"></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${stockStatus.class}">
                                    ${stockStatus.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.lastPurchased)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-item" data-id="${item.id}">Edit</button>
                                <button class="text-red-600 hover:text-red-900 delete-item" data-id="${item.id}">Hapus</button>
                            </td>
                        </tr>
                    `;
                });
                elements.itemsTableBody.innerHTML = itemsHTML;

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-item').forEach(button => {
                    button.addEventListener('click', () => editItem(button.dataset.id));
                });
                document.querySelectorAll('.delete-item').forEach(button => {
                    button.addEventListener('click', () => deleteItem(button.dataset.id));
                });
            }

            // Update pagination info
            elements.itemsDisplayStart.textContent = filteredItems.length > 0 ? startIndex + 1 : 0;
            elements.itemsDisplayEnd.textContent = endIndex;
            elements.itemsTotal.textContent = filteredItems.length;

            // Update pagination buttons
            updatePaginationButtons('items', itemsCurrentPage, totalPages);
        }

        function updatePaginationButtons(type, currentPage, totalPages) {
            let paginationNumbers, prevButton, nextButton;
            
            if (type === 'items') {
                paginationNumbers = elements.itemsPaginationNumbers;
                prevButton = elements.itemsPrevPage;
                nextButton = elements.itemsNextPage;
            } else if (type === 'orders') {
                paginationNumbers = elements.ordersPaginationNumbers;
                prevButton = elements.ordersPrevPage;
                nextButton = elements.ordersNextPage;
            } else if (type === 'requests') {
                paginationNumbers = elements.requestsPaginationNumbers;
                prevButton = elements.requestsPrevPage;
                nextButton = elements.requestsNextPage;
            }
            
            // Clear existing pagination numbers
            paginationNumbers.innerHTML = '';
            
            // Generate pagination numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium ${
                    i === currentPage 
                    ? 'z-10 bg-indigo-50 border-indigo-500 text-indigo-600' 
                    : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'
                }`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => {
                    if (type === 'items') {
                        itemsCurrentPage = i;
                        updateItemsTable();
                    } else if (type === 'orders') {
                        ordersCurrentPage = i;
                        updateOrdersTable();
                    } else if (type === 'requests') {
                        requestsCurrentPage = i;
                        updateRequestsDisplay();
                    }
                });
                paginationNumbers.appendChild(pageButton);
            }
            
            // Update prev/next buttons state
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
        }

        // Orders Management Functions
        function updateOrdersTable() {
            const searchTerm = elements.searchOrder.value.toLowerCase();
            const statusFilter = elements.statusFilter.value;
            
            const filteredOrders = allOrders.filter(order => {
                const matchesSearch = 
                    order.customerName.toLowerCase().includes(searchTerm) ||
                    order.department.toLowerCase().includes(searchTerm) ||
                    order.items.some(item => item.name.toLowerCase().includes(searchTerm));
                
                const matchesStatus = statusFilter ? order.status === statusFilter : true;
                
                return matchesSearch && matchesStatus;
            });

            // Calculate pagination
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            const startIndex = (ordersCurrentPage - 1) * ordersPerPage;
            const endIndex = Math.min(startIndex + ordersPerPage, filteredOrders.length);
            const paginatedOrders = filteredOrders.slice(startIndex, endIndex);

            // Update table
            if (paginatedOrders.length === 0) {
                elements.ordersTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Tidak ada data pemesanan.
                        </td>
                    </tr>
                `;
            } else {
                let ordersHTML = '';
                paginatedOrders.forEach((order, index) => {
                    ordersHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${startIndex + index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${order.customerName}</div>
                                <div class="text-sm text-gray-500">${order.email}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.department}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(order.orderDate)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">${order.items.length} item</div>
                                <div class="text-xs text-gray-500">${order.items.map(item => item.name).join(', ')}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <select class="status-badge ${getOrderStatusClass(order.status)} status-selector" data-id="${order.id}">
                                    <option value="Baru" ${order.status === 'Baru' ? 'selected' : ''}>Baru</option>
                                    <option value="Diproses" ${order.status === 'Diproses' ? 'selected' : ''}>Diproses</option>
                                    <option value="Selesai" ${order.status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                                    <option value="Dibatalkan" ${order.status === 'Dibatalkan' ? 'selected' : ''}>Dibatalkan</option>
                                </select>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 view-order" data-id="${order.id}">Lihat</button>
                            </td>
                        </tr>
                    `;
                });
                elements.ordersTableBody.innerHTML = ordersHTML;

                // Add event listeners to status selectors
                document.querySelectorAll('.status-selector').forEach(select => {
                    select.addEventListener('change', (e) => {
                        updateOrderStatus(e.target.dataset.id, e.target.value);
                    });
                });

                // Add event listeners to view buttons
                document.querySelectorAll('.view-order').forEach(button => {
                    button.addEventListener('click', () => viewOrderDetails(button.dataset.id));
                });
            }

            // Update pagination info
            elements.ordersDisplayStart.textContent = filteredOrders.length > 0 ? startIndex + 1 : 0;
            elements.ordersDisplayEnd.textContent = endIndex;
            elements.ordersTotal.textContent = filteredOrders.length;

            // Update pagination buttons
            updatePaginationButtons('orders', ordersCurrentPage, totalPages);
        }

        // Fungsi untuk mengurangi stok saat pesanan selesai
        async function updateStockOnOrderCompletion(orderId, newStatus) {
            if (newStatus !== 'Selesai') return;
            
            try {
                // Ambil data pesanan
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    console.error('Pesanan tidak ditemukan');
                    return;
                }
                
                const order = orderDoc.data();
                
                // Kurangi stok untuk setiap item dalam pesanan
                const batch = db.batch();
                
                for (const item of order.items) {
                    const itemRef = db.collection('items').doc(item.id);
                    const itemDoc = await itemRef.get();
                    
                    if (itemDoc.exists) {
                        const currentItem = itemDoc.data();
                        const newStock = currentItem.stock - item.quantity;
                        
                        // Pastikan stok tidak negatif
                        if (newStock >= 0) {
                            batch.update(itemRef, { 
                                stock: newStock,
                                lastPurchased: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            console.warn(`Stok tidak cukup untuk ${item.name}. Stok saat ini: ${currentItem.stock}, diperlukan: ${item.quantity}`);
                            // Opsional: Batalkan update status pesanan jika stok tidak cukup
                            // return; 
                        }
                    }
                }
                
                // Commit batch update
                await batch.commit();
                console.log('Stok berhasil diperbarui untuk pesanan:', orderId);
                
            } catch (error) {
                console.error('Error memperbarui stok:', error);
            }
        }

        // Fungsi untuk memvalidasi stok sebelum menyelesaikan pesanan
        async function validateStockBeforeCompletion(orderId) {
            try {
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (!orderDoc.exists) {
                    throw new Error('Pesanan tidak ditemukan');
                }
                
                const order = orderDoc.data();
                const insufficientStockItems = [];
                
                // Periksa ketersediaan stok untuk setiap item
                for (const item of order.items) {
                    const itemDoc = await db.collection('items').doc(item.id).get();
                    if (itemDoc.exists) {
                        const currentItem = itemDoc.data();
                        if (currentItem.stock < item.quantity) {
                            insufficientStockItems.push({
                                name: item.name,
                                required: item.quantity,
                                available: currentItem.stock
                            });
                        }
                    }
                }
                
                return insufficientStockItems;
                
            } catch (error) {
                console.error('Error validasi stok:', error);
                return [];
            }
        }

        // Update Order Status dengan pengecekan stok
        async function updateOrderStatus(orderId, newStatus) {
            try {
                // Jika status berubah menjadi "Selesai", validasi stok terlebih dahulu
                if (newStatus === 'Selesai') {
                    const insufficientStock = await validateStockBeforeCompletion(orderId);
                    
                    if (insufficientStock.length > 0) {
                        let errorMessage = 'Stok tidak cukup untuk menyelesaikan pesanan:\n';
                        insufficientStock.forEach(item => {
                            errorMessage += `- ${item.name}: Diperlukan ${item.required}, Tersedia ${item.available}\n`;
                        });
                        
                        alert(errorMessage);
                        return; // Jangan update status jika stok tidak cukup
                    }
                }
                
                // Update status pesanan
                await db.collection('orders').doc(orderId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Jika status berubah menjadi "Selesai", kurangi stok
                if (newStatus === 'Selesai') {
                    await updateStockOnOrderCompletion(orderId, newStatus);
                }
                
                console.log(`Status pesanan ${orderId} berhasil diubah menjadi ${newStatus}`);
                
            } catch (error) {
                console.error('Error mengupdate status pesanan:', error);
                alert('Terjadi kesalahan saat mengupdate status pesanan');
            }
        }

        function viewOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const itemsList = order.items.map(item => 
                `<li class="flex justify-between py-2 border-b border-gray-200">
                    <span>${item.name}</span>
                    <span>${item.quantity} x ${formatCurrency(item.price)}</span>
                </li>`
            ).join('');

            const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            const modalHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">Detail Pesanan</h3>
                            <button class="text-gray-400 hover:text-gray-600 close-modal">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h4 class="font-medium text-gray-700">Informasi Pemesan</h4>
                                    <p class="mt-1">${order.customerName}</p>
                                    <p class="text-sm text-gray-600">${order.email}</p>
                                    <p class="text-sm text-gray-600">${order.department}</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700">Informasi Pesanan</h4>
                                    <p class="mt-1">${formatDateTime(order.orderDate)}</p>
                                    <p class="text-sm text-gray-600">Status: <span class="status-badge ${getOrderStatusClass(order.status)}">${order.status}</span></p>
                                </div>
                            </div>
                            
                            <h4 class="font-medium text-gray-700 mb-3">Items Pesanan</h4>
                            <ul class="border border-gray-200 rounded-lg divide-y divide-gray-200 mb-6">
                                ${itemsList}
                            </ul>
                            
                            <div class="flex justify-between items-center border-t border-gray-200 pt-4">
                                <span class="font-medium text-gray-700">Total</span>
                                <span class="font-semibold text-lg">${formatCurrency(total)}</span>
                            </div>
                        </div>
                        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end">
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium close-modal">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);

            // Add event listeners to close buttons
            modalContainer.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    document.body.removeChild(modalContainer);
                });
            });
        }

        // Low Stock Management
        function updateLowStockCards() {
            // Filter items with low stock (≤20%)
            const lowStockItems = allItems.filter(item => {
                const percentage = (item.stock / item.maxStock) * 100;
                return percentage <= 20 && item.stock > 0;
            });

            // Calculate pagination
            const totalPages = Math.ceil(lowStockItems.length / lowStockItemsPerPage);
            const startIndex = (lowStockCurrentPage - 1) * lowStockItemsPerPage;
            const endIndex = Math.min(startIndex + lowStockItemsPerPage, lowStockItems.length);
            const paginatedItems = lowStockItems.slice(startIndex, endIndex);

            // Update cards
            if (paginatedItems.length === 0) {
                elements.lowStockCards.innerHTML = `
                    <div class="text-center py-8 col-span-full">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-3"></i>
                        <p class="text-gray-500">Tidak ada barang dengan stok rendah.</p>
                    </div>
                `;
            } else {
                let cardsHTML = '';
                paginatedItems.forEach(item => {
                    const percentage = Math.round((item.stock / item.maxStock) * 100);
                    cardsHTML += `
                        <div class="stock-card low-stock bg-white rounded-lg shadow p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-semibold text-gray-800">${item.name}</h3>
                                <span class="text-xs font-medium px-2 py-1 rounded-full bg-red-100 text-red-800">
                                    ${percentage}%
                                </span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">${item.category}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">Stok: ${item.stock}/${item.maxStock}</span>
                                <button class="text-indigo-600 hover:text-indigo-900 text-sm font-medium restock-item" data-id="${item.id}">
                                    Restock
                                </button>
                            </div>
                        </div>
                    `;
                });
                elements.lowStockCards.innerHTML = cardsHTML;

                // Add event listeners to restock buttons
                document.querySelectorAll('.restock-item').forEach(button => {
                    button.addEventListener('click', () => restockItem(button.dataset.id));
                });
            }

            // Update pagination info
            elements.lowStockCurrentPage.textContent = lowStockCurrentPage;
            elements.lowStockTotalPages.textContent = totalPages;

            // Update button states
            elements.lowStockPrevPage.disabled = lowStockCurrentPage === 1;
            elements.lowStockNextPage.disabled = lowStockCurrentPage === totalPages || totalPages === 0;
        }

        // Requests Management Functions
        function updateRequestsDisplay() {
            const statusFilter = elements.requestStatusFilter.value;
            
            const filteredRequests = allRequests.filter(request => 
                statusFilter ? request.status === statusFilter : true
            );

            // Calculate pagination
            const totalPages = Math.ceil(filteredRequests.length / requestsPerPage);
            const startIndex = (requestsCurrentPage - 1) * requestsPerPage;
            const endIndex = Math.min(startIndex + requestsPerPage, filteredRequests.length);
            const paginatedRequests = filteredRequests.slice(startIndex, endIndex);

            // Update display
            if (paginatedRequests.length === 0) {
                elements.atkRequestsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">Tidak ada permintaan ATK.</p>
                    </div>
                `;
            } else {
                let requestsHTML = '';
                paginatedRequests.forEach((request, index) => {
                    requestsHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-semibold text-gray-800">${request.requesterName}</h3>
                                    <p class="text-sm text-gray-600">${request.department} • ${formatDateTime(request.requestDate)}</p>
                                </div>
                                <span class="status-badge ${getRequestStatusClass(request.status)}">${request.status}</span>
                            </div>
                            
                            <div class="mb-3">
                                <h4 class="font-medium text-gray-700 mb-2">Items yang Diminta:</h4>
                                <ul class="space-y-2">
                                    ${request.items.map(item => `
                                        <li class="flex justify-between text-sm">
                                            <span>${item.name}</span>
                                            <span class="font-medium">${item.quantity} ${item.unit}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            
                            ${request.notes ? `
                                <div class="mb-3">
                                    <h4 class="font-medium text-gray-700 mb-1">Catatan:</h4>
                                    <p class="text-sm text-gray-600">${request.notes}</p>
                                </div>
                            ` : ''}
                            
                            ${request.status === 'Pending' ? `
                                <div class="flex space-x-2">
                                    <button class="approve-request bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium flex items-center" data-id="${request.id}">
                                        <i class="fas fa-check mr-1"></i> Setujui
                                    </button>
                                    <button class="reject-request bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-medium flex items-center" data-id="${request.id}">
                                        <i class="fas fa-times mr-1"></i> Tolak
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                elements.atkRequestsContainer.innerHTML = requestsHTML;

                // Add event listeners to action buttons
                document.querySelectorAll('.approve-request').forEach(button => {
                    button.addEventListener('click', () => updateRequestStatus(button.dataset.id, 'Approved'));
                });
                document.querySelectorAll('.reject-request').forEach(button => {
                    button.addEventListener('click', () => updateRequestStatus(button.dataset.id, 'Rejected'));
                });
            }

            // Update pagination info
            elements.requestsDisplayStart.textContent = filteredRequests.length > 0 ? startIndex + 1 : 0;
            elements.requestsDisplayEnd.textContent = endIndex;
            elements.requestsTotal.textContent = filteredRequests.length;

            // Update pagination buttons
            updatePaginationButtons('requests', requestsCurrentPage, totalPages);
        }

        async function updateRequestStatus(requestId, newStatus) {
            try {
                await db.collection('atkRequests').doc(requestId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log(`Status permintaan ${requestId} berhasil diubah menjadi ${newStatus}`);
            } catch (error) {
                console.error('Error mengupdate status permintaan:', error);
                alert('Terjadi kesalahan saat mengupdate status permintaan');
            }
        }

        // Export Functions
        function exportToExcel(data, filename, headers) {
            try {
                const ws = XLSX.utils.json_to_sheet(data, { header: headers });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, `${filename}.xlsx`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Terjadi kesalahan saat mengekspor data');
            }
        }

        function exportItems() {
            const headers = ['Nama Barang', 'Kategori', 'Stok', 'Stok Maksimum', 'Status', 'Terakhir Dibeli'];
            const data = allItems.map(item => ({
                'Nama Barang': item.name,
                'Kategori': item.category,
                'Stok': item.stock,
                'Stok Maksimum': item.maxStock,
                'Status': getStockStatus(item.stock, item.maxStock).status,
                'Terakhir Dibeli': formatDate(item.lastPurchased)
            }));
            
            exportToExcel(data, 'Data_Barang', headers);
        }

        function exportOrders() {
            const headers = ['Pemesan', 'Email', 'Departemen', 'Tanggal Pesanan', 'Jumlah Item', 'Total', 'Status'];
            const data = allOrders.map(order => {
                const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                return {
                    'Pemesan': order.customerName,
                    'Email': order.email,
                    'Departemen': order.department,
                    'Tanggal Pesanan': formatDate(order.orderDate),
                    'Jumlah Item': order.items.length,
                    'Total': total,
                    'Status': order.status
                };
            });
            
            exportToExcel(data, 'Data_Pemesanan', headers);
        }

        function exportRequests() {
            const headers = ['Pemohon', 'Departemen', 'Tanggal Permintaan', 'Jumlah Item', 'Catatan', 'Status'];
            const data = allRequests.map(request => ({
                'Pemohon': request.requesterName,
                'Departemen': request.department,
                'Tanggal Permintaan': formatDate(request.requestDate),
                'Jumlah Item': request.items.length,
                'Catatan': request.notes || '-',
                'Status': request.status
            }));
            
            exportToExcel(data, 'Data_Permintaan_ATK', headers);
        }

        function exportLowStock() {
            const lowStockItems = allItems.filter(item => {
                const percentage = (item.stock / item.maxStock) * 100;
                return percentage <= 20;
            });
            
            const headers = ['Nama Barang', 'Kategori', 'Stok', 'Stok Maksimum', 'Persentase'];
            const data = lowStockItems.map(item => {
                const percentage = Math.round((item.stock / item.maxStock) * 100);
                return {
                    'Nama Barang': item.name,
                    'Kategori': item.category,
                    'Stok': item.stock,
                    'Stok Maksimum': item.maxStock,
                    'Persentase': `${percentage}%`
                };
            });
            
            exportToExcel(data, 'Data_Stok_Rendah', headers);
        }

        function exportAllData() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Export Items
            const itemsData = allItems.map(item => ({
                'Nama Barang': item.name,
                'Kategori': item.category,
                'Stok': item.stock,
                'Stok Maksimum': item.maxStock,
                'Status': getStockStatus(item.stock, item.maxStock).status,
                'Terakhir Dibeli': formatDate(item.lastPurchased)
            }));
            const itemsWS = XLSX.utils.json_to_sheet(itemsData);
            XLSX.utils.book_append_sheet(wb, itemsWS, "Data Barang");
            
            // Export Orders
            const ordersData = allOrders.map(order => {
                const total = order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                return {
                    'Pemesan': order.customerName,
                    'Email': order.email,
                    'Departemen': order.department,
                    'Tanggal Pesanan': formatDate(order.orderDate),
                    'Jumlah Item': order.items.length,
                    'Total': total,
                    'Status': order.status
                };
            });
            const ordersWS = XLSX.utils.json_to_sheet(ordersData);
            XLSX.utils.book_append_sheet(wb, ordersWS, "Data Pemesanan");
            
            // Export Requests
            const requestsData = allRequests.map(request => ({
                'Pemohon': request.requesterName,
                'Departemen': request.department,
                'Tanggal Permintaan': formatDate(request.requestDate),
                'Jumlah Item': request.items.length,
                'Catatan': request.notes || '-',
                'Status': request.status
            }));
            const requestsWS = XLSX.utils.json_to_sheet(requestsData);
            XLSX.utils.book_append_sheet(wb, requestsWS, "Data Permintaan ATK");
            
            // Export Low Stock
            const lowStockItems = allItems.filter(item => {
                const percentage = (item.stock / item.maxStock) * 100;
                return percentage <= 20;
            });
            const lowStockData = lowStockItems.map(item => {
                const percentage = Math.round((item.stock / item.maxStock) * 100);
                return {
                    'Nama Barang': item.name,
                    'Kategori': item.category,
                    'Stok': item.stock,
                    'Stok Maksimum': item.maxStock,
                    'Persentase': `${percentage}%`
                };
            });
            const lowStockWS = XLSX.utils.json_to_sheet(lowStockData);
            XLSX.utils.book_append_sheet(wb, lowStockWS, "Data Stok Rendah");
            
            // Save the workbook
            XLSX.writeFile(wb, "Rekap_Lengkap_Data.xlsx");
        }

        // Item Management Functions
        function addItem() {
            // Implementation for adding a new item
            alert('Fungsi tambah barang akan diimplementasikan di sini');
        }

        function editItem(itemId) {
            // Implementation for editing an item
            alert(`Fungsi edit barang untuk ID: ${itemId} akan diimplementasikan di sini`);
        }

        function deleteItem(itemId) {
            if (confirm('Apakah Anda yakin ingin menghapus barang ini?')) {
                db.collection('items').doc(itemId).delete()
                    .then(() => {
                        console.log('Barang berhasil dihapus');
                    })
                    .catch(error => {
                        console.error('Error menghapus barang:', error);
                        alert('Terjadi kesalahan saat menghapus barang');
                    });
            }
        }

        function restockItem(itemId) {
            // Implementation for restocking an item
            alert(`Fungsi restock barang untuk ID: ${itemId} akan diimplementasikan di sini`);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Event Listeners
        function setupEventListeners() {
            // Tab Navigation
            elements.tabItems.addEventListener('click', () => {
                switchTab('items');
            });
            elements.tabOrders.addEventListener('click', () => {
                switchTab('orders');
            });
            elements.tabRequests.addEventListener('click', () => {
                switchTab('requests');
            });

            // Search and Filter
            elements.searchItem.addEventListener('input', debounce(updateItemsTable, 300));
            elements.searchOrder.addEventListener('input', debounce(updateOrdersTable, 300));
            elements.statusFilter.addEventListener('change', updateOrdersTable);
            elements.requestStatusFilter.addEventListener('change', updateRequestsDisplay);

            // Pagination
            elements.itemsPrevPage.addEventListener('click', () => {
                if (itemsCurrentPage > 1) {
                    itemsCurrentPage--;
                    updateItemsTable();
                }
            });
            elements.itemsNextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(allItems.length / itemsPerPage);
                if (itemsCurrentPage < totalPages) {
                    itemsCurrentPage++;
                    updateItemsTable();
                }
            });

            elements.ordersPrevPage.addEventListener('click', () => {
                if (ordersCurrentPage > 1) {
                    ordersCurrentPage--;
                    updateOrdersTable();
                }
            });
            elements.ordersNextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(allOrders.length / ordersPerPage);
                if (ordersCurrentPage < totalPages) {
                    ordersCurrentPage++;
                    updateOrdersTable();
                }
            });

            elements.requestsPrevPage.addEventListener('click', () => {
                if (requestsCurrentPage > 1) {
                    requestsCurrentPage--;
                    updateRequestsDisplay();
                }
            });
            elements.requestsNextPage.addEventListener('click', () => {
                const totalPages = Math.ceil(allRequests.length / requestsPerPage);
                if (requestsCurrentPage < totalPages) {
                    requestsCurrentPage++;
                    updateRequestsDisplay();
                }
            });

            elements.lowStockPrevPage.addEventListener('click', () => {
                if (lowStockCurrentPage > 1) {
                    lowStockCurrentPage--;
                    updateLowStockCards();
                }
            });
            elements.lowStockNextPage.addEventListener('click', () => {
                const lowStockItems = allItems.filter(item => {
                    const percentage = (item.stock / item.maxStock) * 100;
                    return percentage <= 20 && item.stock > 0;
                });
                const totalPages = Math.ceil(lowStockItems.length / lowStockItemsPerPage);
                if (lowStockCurrentPage < totalPages) {
                    lowStockCurrentPage++;
                    updateLowStockCards();
                }
            });

            // Calendar Navigation
            elements.prevMonth.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                updateCalendar();
            });
            elements.nextMonth.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                updateCalendar();
            });

            // Export Buttons
            elements.exportItemsButton.addEventListener('click', exportItems);
            elements.exportOrdersButton.addEventListener('click', exportOrders);
            elements.exportRequestsButton.addEventListener('click', exportRequests);
            elements.exportLowStockButton.addEventListener('click', exportLowStock);
            elements.exportAllData.addEventListener('click', exportAllData);

            // Action Buttons
            elements.addItemButton.addEventListener('click', addItem);
            elements.logoutButton.addEventListener('click', logout);
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-indigo-500', 'text-indigo-600');
                button.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Activate selected tab
            if (tabName === 'items') {
                elements.tabItems.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                elements.tabItems.classList.add('border-indigo-500', 'text-indigo-600');
                elements.tabContentItems.classList.remove('hidden');
            } else if (tabName === 'orders') {
                elements.tabOrders.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                elements.tabOrders.classList.add('border-indigo-500', 'text-indigo-600');
                elements.tabContentOrders.classList.remove('hidden');
            } else if (tabName === 'requests') {
                elements.tabRequests.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                elements.tabRequests.classList.add('border-indigo-500', 'text-indigo-600');
                elements.tabContentRequests.classList.remove('hidden');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin logout?')) {
                auth.signOut().then(() => {
                    window.location.href = 'login.html';
                }).catch(error => {
                    console.error('Error logging out:', error);
                });
            }
        }

        // Initialize App
        function initApp() {
            // Check authentication state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    console.log('User is signed in:', user.email);
                    initializeFirebaseListeners();
                    setupEventListeners();
                    updateCalendar();
                } else {
                    // User is signed out, redirect to login
                    window.location.href = 'login.html';
                }
            });
        }

        // Start the application
        initApp();
    </script>
</body>
</html>
