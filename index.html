<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Barang ATK 2025</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { text-align: center; }
    #controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    button { padding: 8px 12px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <h1>Rekap Barang ATK 2025</h1>

  <div id="controls">
    <input type="text" id="searchInput" placeholder="Cari barang...">
    <select id="filterKategori">
      <option value="">Semua Kategori</option>
    </select>
    <button onclick="exportToExcel()">Download Excel</button>
    <button onclick="exportToPDF()">Download PDF</button>
  </div>

  <table id="rekapTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script>
    const sheetID = '1AlxZR5kufSMd2oWZScDGjnB_fwJBaBvxDwPyhLtS3uc';
    const url = `https://opensheet.elk.sh/${sheetID}/Sheet1`;
    let allData = [];

    fetch(url)
      .then(res => res.json())
      .then(json => {
        const headerRowIndex = json.findIndex(row =>
          row["No"]?.trim().toLowerCase() === "no" &&
          row["Nama Barang"]?.trim().toLowerCase() === "nama barang"
        );

        if (headerRowIndex === -1) throw new Error("Header tidak ditemukan");

        const headers = Object.values(json[headerRowIndex]);
        const data = json.slice(headerRowIndex + 1);

        allData = data.map(row => {
          const newRow = {};
          headers.forEach((h, i) => {
            newRow[h] = Object.values(row)[i] ?? '';
          });
          return newRow;
        });

        renderTable(allData, headers);
        populateDropdown(allData);

        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('filterKategori').addEventListener('change', filterData);
      })
      .catch(err => {
        document.body.innerHTML += `<p style="color:red">Gagal memuat data: ${err}</p>`;
      });

    function renderTable(data, headers) {
      const thead = document.querySelector('#rekapTable thead');
      const tbody = document.querySelector('#rekapTable tbody');
      thead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
      tbody.innerHTML = data.map(row => {
        return `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`;
      }).join('');
    }

    function populateDropdown(data) {
      const kategoriSet = new Set(data.map(row => row['Kategori']).filter(Boolean));
      const select = document.getElementById('filterKategori');
      select.innerHTML = '<option value="">Semua Kategori</option>';
      [...kategoriSet].sort().forEach(kat => {
        select.innerHTML += `<option value="${kat}">${kat}</option>`;
      });
    }

    function filterData() {
      const keyword = document.getElementById('searchInput').value.toLowerCase();
      const kategori = document.getElementById('filterKategori').value;
      const filtered = allData.filter(row => {
        const cocokKategori = kategori === '' || row['Kategori'] === kategori;
        const cocokCari = Object.values(row).some(val =>
          String(val).toLowerCase().includes(keyword)
        );
        return cocokKategori && cocokCari;
      });
      renderTable(filtered, Object.keys(allData[0]));
    }

    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(allData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Rekap Barang");
      XLSX.writeFile(wb, "Rekap_Barang_ATK_2025.xlsx");
    }

    async function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const headers = Object.keys(allData[0]);
      const rows = allData.map(row => headers.map(h => row[h] || ''));
      doc.autoTable({
        head: [headers],
        body: rows,
        startY: 20
      });
      doc.save("Rekap_Barang_ATK_2025.pdf");
    }
  </script>

</body>
</html>
